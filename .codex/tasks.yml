# Wave-A  Î”-003 â€” Knowledge Depth & Retrieval Quality
# Owner: @core-dev (solo)    Sprint target: 5â€“7 calendar days
# Legend:
#   â³  = estimate (ideal hours)
#   ğŸ”¥  = criticalâ€path item
#   âš™ï¸  = build/infra
#   ğŸ§ª = test / QA
#   ğŸ“š = docs

tasks:
  - id: A-1.1
    title: "Create PKG schema config & constraints"
    â³: 3h ğŸ”¥ âš™ï¸
    description: |
      â€¢ Add `ingestion/pkg_config.py` defining ALLOWED_NODE_TYPES, ALLOWED_EDGE_TYPES,
        and SCHEMA_CONSTRAINTS (Cypher).
      â€¢ Provide helper `install_constraints(tx)` to run at bootstrap.
    acceptance_criteria:
      - File exists and is imported by `build_pkg.py`.
      - `python ingestion/build_pkg.py` on a fresh Neo4j volume exits 0.
      - Neo4j Browser `CALL db.constraints` lists three uniqueness constraints.

  - id: A-1.2
    title: "Bootstrap constraints at container start"
    â³: 1h ğŸ”¥ âš™ï¸
    depends_on: [A-1.1]
    description: |
      â€¢ Mount `constraints.cypher` into `docker-compose.yml` under neo4j
        `neo4j-admin init` or via `/docker-entrypoint-initdb.d/`.
      â€¢ Update DEV_ENV.md with note on first-run constraint install.
    acceptance_criteria:
      - `docker compose down -v && docker compose up -d neo4j`
        shows constraints installed automatically.

  - id: A-1.3
    title: "Filter hallucinated triples in build_pkg.py"
    â³: 2h ğŸ”¥
    depends_on: [A-1.1]
    description: |
      â€¢ Wrap `transformer.convert()` output, discard triples with disallowed
        subject/object/predicate types.
    acceptance_criteria:
      - Unit test injecting forbidden "Wizard" node yields 0 inserts.
      - Coverage for new path â‰¥ 95 %.

  - id: A-2.1
    title: "Implement two-step RAG retrieval"
    â³: 4h ğŸ”¥
    description: |
      â€¢ Split `agent/retrieve_context.py` into `query_pkg()` and
        `filter_qdrant_by_entities()`.
      â€¢ Use metadata filter `entities` in Qdrant.
      â€¢ Add fallback branch: if filtered search returns 0 docs, rerun plain
        vector search (logs warning).
    acceptance_criteria:
      - Integration test: when PKG has entity â€œAliceâ€, only Alice docs
        returned.
      - Fallback path unit-tested.

  - id: A-2.2
    title: "Add Neo4j service to CI workflow"
    â³: 1h âš™ï¸ ğŸ§ª
    depends_on: [A-2.1]
    description: |
      â€¢ Edit `.github/workflows/ci.yml`: add `neo4j:5.20` service with auth,
        set `NEO4J_AUTH=neo4j/password`.
      â€¢ Inject env vars in test step (`export NEO4J_URI` etc.).
    acceptance_criteria:
      - CI pipeline green with new service.
      - Total runtime increase â‰¤ 2 min.

  - id: A-3.1
    title: "Accurate token counter & global trim guard"
    â³: 3h ğŸ”¥
    description: |
      â€¢ Add `utils/token_counter.py` using `tiktoken` (fallback to naÃ¯ve split).
      â€¢ Apply `trim_messages()` in `plan_step`, `execute_tool`, `generate_response`.
      â€¢ Annotate Langfuse trace meta `{trimmed: true, token_delta: N}`.
    acceptance_criteria:
      - 12 k-token synthetic prompt processed without `context_length` error.
      - Unit test covers trim logic; tokens post-trim â‰¤ 8 k.

  - id: A-4.1
    title: "Dynamic embedding pipeline & ingestion hook"
    â³: 4h ğŸ”¥
    description: |
      â€¢ Create `ingestion/embedding_pipeline.py` with strategies `recursive`, `sentence`, `none`.
      â€¢ Replace current logic in `ingestion/ingest.py` to call new pipeline
        and store `split_strategy` metadata in Qdrant.
    acceptance_criteria:
      - Ingest sample PDF â†’ vectors show `split_strategy:"recursive"`.
      - Ingest short note â†’ `split_strategy:"none"`.
      - Tests verify strategy selection.

  - id: A-4.2
    title: "Vector store schema upgrade for entities metadata"
    â³: 2h âš™ï¸
    depends_on: [A-4.1]
    description: |
      â€¢ Migrate Qdrant collection: add payload index on `entities` array for fast filter.
      â€¢ Provide migration script `scripts/migrate_qdrant_0.4.0.py`.
    acceptance_criteria:
      - Migration script creates index, runs idempotently.
      - `qdrant_client.get_collection_info()` shows payload index.

  - id: A-5.0
    title: "Raise coverage back to â‰¥80 %"
    â³: 3h ğŸ§ª
    depends_on: [A-1.3, A-2.1, A-3.1, A-4.1]
    description: |
      â€¢ Add unit tests for trim guard failure path, embedding strategy,
        PKG filter miss.
      â€¢ Use pytest-cov threshold 80 %.
    acceptance_criteria:
      - `make test` passes locally; CI green.

  - id: A-6.0
    title: "Finalize docs & version bump to 0.4.0-rc2"
    â³: 2h ğŸ“š
    description: |
      â€¢ Fill `CHANGELOG.md` with Î”-002 & Î”-003 bullets.
      â€¢ Draft `RELEASE_NOTES.md` with upgrade steps (`make dev`, Neo4j).
      â€¢ Bump version in `pyproject.toml`; add `docbuild` & `docserve`
        targets to Makefile; configure `gh-pages` deploy action via `mike`.
    acceptance_criteria:
      - Docs site builds locally (`mkdocs build --strict`).
      - `version` tag shows in footer; CHANGELOG rendered under â€œChangelogâ€.

  - id: A-7.0
    title: "Full QA matrix & tag v0.4.0-rc2"
    â³: 1h ğŸ§ª
    depends_on: [A-5.0, A-6.0]
    description: |
      â€¢ Execute QA scenarios (Hybrid RAG, overflow guard, HITL) and attach
        Langfuse trace & screenshots to release draft.
      â€¢ Tag `v0.4.0-rc2`, push images, update README badge.
    acceptance_criteria:
      - QA sign-off checklist uploaded to repository `docs/QA/v0.4.0-rc2.md`.
      - GitHub release draft created with artefacts.
